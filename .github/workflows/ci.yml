name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install pre-commit
        run: |
          pip install pre-commit
          pre-commit install

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

      - name: Lint Dockerfile with hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3009,DL3015

      - name: Validate docker-compose.yml
        run: |
          docker compose config

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        version: ['4.0.17']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: fiduswriter/fiduswriter:${{ matrix.version }}
          build-args: |
            FIDUSWRITER_VERSION=${{ matrix.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker build --build-arg FIDUSWRITER_VERSION=${{ matrix.version }} -t fiduswriter-test:${{ matrix.version }} .
          docker run -d --name fiduswriter-test -p 8000:8000 fiduswriter-test:${{ matrix.version }}
          
          # Wait for container to start
          sleep 10
          
          # Check if container is running
          docker ps | grep fiduswriter-test
          
          # Check logs for errors
          docker logs fiduswriter-test
          
          # Cleanup
          docker stop fiduswriter-test
          docker rm fiduswriter-test

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning
          scandir: '.'
          format: gcc

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          args: '**/*.md'
          config: '.markdownlint.json'
          ignore: 'node_modules'